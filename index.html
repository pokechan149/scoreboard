<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>LOL 실시간 전적</title>
    <style>
        body { background: transparent; color: white; font-family: 'Malgun Gothic', sans-serif; padding: 0; margin: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .dashboard { width: 95vw; background: rgba(15, 15, 15, 0.9); border-radius: 1vw; padding: 1.5vw; box-shadow: 0 0.5vw 1.5vw rgba(0,0,0,0.5); }
        .player-row { display: flex; justify-content: space-between; align-items: center; background: #222; margin-bottom: 1vh; padding: 1vh 3.5vw; border-radius: 0.8vw; }
        .blue-team { border-left: 0.8vw solid #3498db; }
        .red-team { border-left: 0.8vw solid #ff5e5e; }
        .player-name { font-size: 5vw; font-weight: bold; color: #ddd; white-space: nowrap; }
        .score-box { font-size: 5.5vw; font-weight: 800; }
        .win-val { color: #4da3ff; margin-right: 2vw; }
        .loss-val { color: #ff5e5e; }
        #status { font-size: 2.5vw; color: #555; text-align: right; margin-top: 0.5vh; padding-right: 1vw; font-weight: bold; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div id="player-list"></div>
        <div id="status">연결 대기 중...</div>
    </div>

    <script>
        const API_KEY = "RGAPI-83625455-6ced-400b-8391-660ac830bb41";
        const PLAYERS = [
            {nickname: "달묘", name: "달묘냥", tag: "냥냥펀치", team: "blue-team"},
            {nickname: "카푸", name: "브라움질리언왁싱", tag: "149", team: "blue-team"},
            {nickname: "몽나", name: "눅눅한 김말이", tag: "김밥천국", team: "red-team"},
            {nickname: "최또", name: "히히오쥼발싸", tag: "1030", team: "red-team"}
        ];

        let scoreData = {};
        PLAYERS.forEach(p => {
            scoreData[p.name] = { win: 0, loss: 0, checkedIds: new Set() };
        });

        const now = new Date();
        const startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 20, 0, 0).getTime();

        // --- 딜레이 함수 추가 ---
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function updateScores() {
            try {
                let html = "";
                for (let player of PLAYERS) {
                    // 1. 계정 정보 조회
                    const accRes = await fetch(`https://asia.api.riotgames.com/riot/account/v1/accounts/by-riot-id/${encodeURIComponent(player.name)}/${encodeURIComponent(player.tag)}?api_key=${API_KEY}`);
                    const accData = await accRes.json();
                    if (!accData.puuid) continue;
                    const puuid = accData.puuid;
                    await wait(200); // 0.2초 휴식

                    // 2. 매치 목록 조회
                    const matchRes = await fetch(`https://asia.api.riotgames.com/lol/match/v5/matches/by-puuid/${puuid}/ids?start=0&count=5&api_key=${API_KEY}`);
                    const matchIds = await matchRes.json();
                    await wait(200); // 0.2초 휴식

                    // 3. 매치 상세 조회 (반복문 내부 딜레이)
                    for (let mId of matchIds) {
                        if (scoreData[player.name].checkedIds.has(mId)) continue;
                        const detailRes = await fetch(`https://asia.api.riotgames.com/lol/match/v5/matches/${mId}?api_key=${API_KEY}`);
                        const mData = await detailRes.json();
                        
                        if (mData.info.gameEndTimestamp > startTime) {
                            const me = mData.info.participants.find(p => p.puuid === puuid);
                            if (me.win) scoreData[player.name].win++;
                            else scoreData[player.name].loss++;
                        }
                        scoreData[player.name].checkedIds.add(mId);
                        await wait(200); // 각 판 확인 후 0.2초 휴식
                    }

                    const pScore = scoreData[player.name];
                    html += `
                        <div class="player-row ${player.team}">
                            <div class="player-name">${player.nickname}</div>
                            <div class="score-box">
                                <span class="win-val">${pScore.win}W</span>
                                <span class="loss-val">${pScore.loss}L</span>
                            </div>
                        </div>`;
                }
                document.getElementById('player-list').innerHTML = html;
                const timeString = new Date().toLocaleTimeString('ko-KR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                document.getElementById('status').innerText = "Update: " + timeString;
                document.getElementById('status').style.color = "#555";
            } catch (e) { 
                console.error(e); 
                document.getElementById('status').innerText = "API 오류 발생";
                document.getElementById('status').style.color = "#ff5e5e";
            }
        }

        updateScores();
        // 1분 간격으로 업데이트 (2분당 100회 제한 준수)
        setInterval(updateScores, 60000);
    </script>
</body>
</html>
